---
title: DNS负载均衡
tags:
  - DNS
  - 运维
id: '12028'
categories:
  - - skills
date: 2020-03-26 09:43:03
---

# DNS 负载均衡

前两天学习 `python` 模块 `dnspython` 时发现`baidu.com`的 dns A 记录有两个地址，顺便记录下`DNS`负载。

## 原理

DNS（Domain Name System）是因特网的一项服务，它作为域名和IP地址相互映射的一个分布式数据库，能够使人更方便的访问互联网。人们在通过浏览器访问网站时只需要记住网站的域名即可，而不需要记住那些不太容易理解的IP地址。在DNS系统中有一个比较重要的的资源类型叫做主机记录也称为A记录，A记录是用于名称解析的重要记录，它将特定的主机名映射到对应主机的IP地址上。如果你有一个自己的域名，那么要想别人能访问到你的网站，你需要到特定的DNS解析服务商的服务器上填写A记录，过一段时间后，别人就能通过你的域名访问你的网站了。DNS除了能解析域名之外还具有负载均衡的功能，<!--more--> 原理图： ![image.png](https://i.loli.net/2020/03/26/LJTnrHxjYgchG6X.png) 由上图可以看出，在DNS服务器中应该配置了多个A记录，如： `www.apusapp.com IN A 114.100.20.201;` `www.apusapp.com IN A 114.100.20.202;` `www.apusapp.com IN A 114.100.20.203;` 因此，每次域名解析请求都会根据对应的负载均衡算法计算出一个不同的IP地址并返回，这样A记录中配置多个服务器就可以构成一个集群，并可以实现负载均衡。上图中，用户请求`www.apusapp.com`，DNS根据A记录和负载均衡算法计算得到一个IP地址`114.100.20.203`，并返回给浏览器，浏览器根据该IP地址，访问真实的物理服务器`114.100.20.203`。所有这些操作对用户来说都是透明的，用户可能只知道`www.apusapp.com`这个域名。

## 优缺点

#### 优点

*   将负载均衡的工作交给DNS，省去了网站管理维护负载均衡服务器的麻烦。
*   技术实现比较灵活、方便，简单易行，成本低，使用于大多数TCP/IP应用。
*   对于部署在服务器上的应用来说不需要进行任何的代码修改即可实现不同机器上的应用访问。
*   服务器可以位于互联网的任意位置。
*   同时许多DNS还支持基于地理位置的域名解析，即会将域名解析成距离用户地理最近的一个服务器地址，这样就可以加速用户访问，改善性能。

#### 缺点

*   目前的DNS是多级解析的，每一级DNS都可能缓存A记录，当某台服务器下线之后，即使修改了A记录，要使其生效也需要较长的时间，这段时间，DNS任然会将域名解析到已下线的服务器上，最终导致用户访问失败。
*   不能够按服务器的处理能力来分配负载。DNS负载均衡采用的是简单的轮询算法，不能区分服务器之间的差异，不能反映服务器当前运行状态，所以其的负载均衡效果并不是太好。
*   可能会造成额外的网络问题。为了使本DNS服务器和其他DNS服务器及时交互，保证DNS数据及时更新，使地址能随机分配，一般都要将DNS的刷新时间设置的较小，但太小将会使DNS流量大增造成额外的网络问题。

## 实践

下面进行实际操作实现 DNS 负载，我将 `dns.52ynn.top`先添加一条 A 记录解析： ![image.png](https://i.loli.net/2020/03/26/wKhDOxCb8V6Fmko.png) 通过解析查询得出一条结果： ![image.png](https://i.loli.net/2020/03/26/FNaXeLZRAvgc3ni.png) 现在我们再加一条 A 记录解析，现在有两条记录 ![image.png](https://i.loli.net/2020/03/26/XvCNMUBnW4eJwVk.png) 再查询下 A 记录结果： ![image.png](https://i.loli.net/2020/03/26/lxFb6LINgOPD4tm.png) 这就实现了 DNS 的负载，会将客户端访问解析到两台后端服务器上。 附上A记录查询代码：

```python
import dns.resolver

domain = input('Please input an domain: ')  # 输入域名地址
A = dns.resolver.query(domain, 'A')  # 指定查询类型为 A 记录
for i in A.response.answer:
    for j in i.items:
        print(j.address)

```