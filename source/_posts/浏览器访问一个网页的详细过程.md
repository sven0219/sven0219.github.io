---
title: 浏览器访问一个网页的详细过程
tags:
  - DNS
  - 运维
id: '12098'
categories:
  - - skills
date: 2020-06-17 16:56:58
---

# 概括

打开浏览器，在地址栏输入 URL，回车，到出现网页内容，这是访问网站必须要经过的一个过程，这个过程可以概括为几个部分： 1. 域名解析成 IP 地址 2. 与目的主机进行 TCP 连接（三次握手） 3. 发送与收取数据（浏览器与目的主机开始 http 访问过程） 4. 与目的主机断开 TCP 连接（四次挥手）
<!--more-->
# 域名解析成 IP 地址

访问目标地址有两种方式，一种是直接通过 ip 加端口进行访问，另外一种是使用域名访问，但是由于 IP 地址是一堆数字不方便记忆，所以就有了域名访问的方式，域名访问会通过 DNS 服务器将域名解析为 IP 地址。 **DNS 解析有会通过如下顺序进行查找域名对应的 IP：** 1. 浏览器首先搜索浏览器自身缓存的DNS记录 2. 如果浏览器缓存中没有找到需要的记录或记录已经过期，则搜索hosts文件。 3. 如果在hosts文件中没有找到需要的记录或记录已经过期，则向域名解析服务器发送解析请求。 **DNS 域名解析使用的是 UDP 协议。整个域名解析过程如下：** 1. 浏览器向本机DNS模块发出DNS请求，DNS模块生成相关的DNS报文； 2. DNS模块将生成的DNS报文传递给传输层的UDP协议单元； 3. UDP协议单元将该数据封装成UDP数据报，传递给网络层的IP协议单元； 4. IP协议单元将该数据封装成IP数据包，其目的IP地址为DNS服务器的IP地址； 5. 封装好的IP数据包将传递给数据链路层的协议单元进行发送； 6. 发送时在ARP缓存中查询相关数据，如果没有，就发送ARP广播（包含待查询的IP地址，收到广播的主机检查自己的IP，符合条件的主机将含有自己MAC地址的ARP包发送给ARP广播的主机）请求，等待ARP回应； 7. 得到ARP回应后，将IP地址与路由的下一跳MAC地址对应的信息写入ARP缓存表； 8. 写入缓存后，以路由下一跳的地址填充目的MAC地址，以数据帧形式转发； 9. 转发可能进行多次； 10. DNS请求到达DNS服务器的数据链路层协议单元； 11. DNS服务器的数据链路层协议单元解析数据帧，将内部的IP数据包传递给网络层IP协议单元； 12. DNS服务器的IP协议单元解析IP数据包，将内部的UDP数据报传递给传输层UDP协议单元； 13. DNS服务器的UDP协议单元解析收到的UDP数据报，将内部的DNS报文传递给DNS服务单元； 14. DNS服务单元将域名解析成对应IP地址，产生DNS回应报文； 15. DNS回应报文->UDP->IP->MAC->我的主机； 16. 我的主机收到数据帧，将数据帧->IP->UDP->浏览器； 17. 将域名解析结果以域名和IP地址对应的形式写入DNS缓存表。

# 与目的主机进行 TCP 连接（三次握手）

1.  向目的主机发送TCP连接请求报文；
2.  该TCP报文中SYN标志位设为1，表示连接请求；
3.  该TCP报文通过IP（DNS）->MAC（ARP）->网关->目的主机；
4.  目的主机收到数据帧，通过IP->TCP，TCP协议单元回应请求应答报文；
5.  该报文中SYN和ACK标志设为1，表示连接请求应答；
6.  该TCP报文通过IP（DNS）->MAC（ARP）->网关->我的主机；
7.  我的主机收到数据帧，通过IP->TCP，TCP协议单元回应请求确认报文；
8.  该TCP报文通过IP（DNS）->MAC（ARP）->网关->目的主机；
9.  目的主机收到数据帧，通过IP->TCP，连接建立完成。

# 发送与收取数据（浏览器与谜底主机开始 HTTP 访问过程）

1只有建立连接后才能开始传输数据。

1.  浏览器向域名发出GET方法报文（HTTP请求）；
2.  该GET方法报文通过TCP->IP（DNS）->MAC（ARP）->网关->目的主机；
3.  目的主机收到数据帧，通过IP->TCP->HTTP，HTTP协议单元会回应HTTP协议格式封装好的HTML形式数据（HTTP响应）；
4.  该HTML数据通过TCP->IP（DNS）->MAC（ARP）->网关->我的主机；
5.  我的主机收到数据帧，通过IP->TCP->HTTP->浏览器，浏览器以网页形式显示HTML内容。

# 与目的主机断开 TCP 连接（四次挥手）

TCP连接释放过程：

1.  浏览器向目的主机发出TCP连接结束请求报文，此时进入FIN WAIT状态；
2.  该报文FIN标志位设为1，表示结束请求；
3.  TCP结束请求报文通过IP（DNS）->MAC（ARP）->网关->目的主机；
4.  目的主机收到数据帧，通过IP->TCP，TCP协议单元回应结束应答报文；
5.  当前只是进行回应，因为目的主机可能还有数据要传，并不急着断开连接；
6.  该报文中ACK标志位设为1，表示收到结束请求；
7.  目的数据发送完所有数据后，向我的主机发出TCP连接结束请求报文；
8.  该报文FIN标志位设为1，表示结束请求；
9.  TCP结束请求报文通过IP（DNS）->MAC（ARP）->网关->我的主机；
10.  我的主机收到数据帧，通过IP->TCP，TCP协议单元回应结束应答报文，此时进入TIME WAIT状态，因为不相信网络是可靠的，如果目的主机没收到还可以重发；
11.  该报文中的FIN标志位均设为1，表示结束应答；
12.  该TCP回应报文通过IP（DNS）->MAC（ARP）->网关->目的主机；
13.  目的主机关闭连接；
14.  TIME WAIT等待结束后，没有收到回复，说明目的正常关闭了，我的主机也关闭连接。

# 总结

URL访问网站时的网络传输全过程，可以归纳为： 首先通过域名找到IP，如果缓存里没有就要请求DNS服务器；得到IP后开始与目的主机进行三次握手来建立TCP连接；连接建立后进行HTTP访问，传输并获取网页内容；传输完后与目的主机四次挥手来断开TCP连接。 [![](https://i.loli.net/2020/06/17/8nhabEuVyXkrN5m.jpg)](https://i.loli.net/2020/06/17/8nhabEuVyXkrN5m.jpg)